<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ë¶€ë™ì‚° ê³„ì‚°ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            color-scheme: light dark;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f4f6ff;
            color: #1f2933;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 48px 24px 36px;
            text-align: center;
        }
        header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
        }
        header p {
            margin: 12px 0 0;
            opacity: 0.88;
        }
        main {
            max-width: 1200px;
            margin: -40px auto 48px;
            padding: 0 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #fff;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 18px 36px rgba(102, 126, 234, 0.15);
        }
        .stat-card h3 {
            margin: 0;
            font-size: 13px;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #667eea;
        }
        .stat-card .value {
            margin-top: 12px;
            font-size: 28px;
            font-weight: 700;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 18px;
        }
        button {
            background: #667eea;
            border: none;
            color: #fff;
            padding: 12px 20px;
            font-weight: 600;
            border-radius: 999px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .nav-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.7);
            color: #fff;
            text-decoration: none;
            font-weight: 600;
            margin-top: 12px;
            backdrop-filter: blur(8px);
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.2);
        }
        button.secondary {
            background: #f093fb;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 28px rgba(102, 126, 234, 0.25);
        }
        .alert-form {
            display: none;
            background: #fff;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 12px 32px rgba(118, 75, 162, 0.12);
        }
        .alert-form.active {
            display: block;
        }
        .alert-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        input, select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid #d7dcff;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        .complex-grid {
            display: grid;
            gap: 22px;
        }
        .complex-card {
            background: #fff;
            border-radius: 22px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(31, 41, 51, 0.12);
        }
        .complex-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 14px;
        }
        .complex-header h2 {
            margin: 0;
            font-size: 22px;
        }
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            background: #eef2ff;
            color: #4451b4;
        }
        .badge.up { background: #ecfdf3; color: #046c4e; }
        .badge.down { background: #fdf2f5; color: #a3063f; }
        .sparkline {
            margin: 0;
            padding: 0;
            height: 200px;
            position: relative;
            overflow-x: auto; /* Add this for horizontal scrolling */
        }
        .room-types, .listing-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0 4px;
        }
        .room-types th, .room-types td,
        .listing-table th, .listing-table td {
            padding: 10px 8px;
            text-align: left;
            font-size: 14px;
        }
        .room-types th, .listing-table th {
            color: #667eea;
            font-weight: 600;
            border-bottom: 1px solid #e5e9ff;
        }
        .room-types tr:nth-child(even),
        .listing-table tr:nth-child(even) {
            background: rgba(102, 126, 234, 0.06);
        }
        .listing-table a {
            color: #5b67d4;
            text-decoration: none;
        }
        .listing-table a:hover {
            text-decoration: underline;
        }
        .empty {
            padding: 12px;
            border-radius: 12px;
            background: #f3f4ff;
            color: #6c708c;
            font-size: 14px;
        }
        @media (max-width: 720px) {
            header h1 { font-size: 26px; }
            .complex-card { padding: 18px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ™ï¸ ë¶€ë™ì‚° ëª¨ë‹ˆí„°ë§: {{ current_query }}</h1>
        <p>ì§ë°© ê³µê°œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ê±°ë˜ ì‹œì„¸ì™€ ì‹¤ì‹œê°„ ë§¤ë¬¼ì„ ì¶”ì í•©ë‹ˆë‹¤.</p>
        <div class="search-container" style="margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
            <form action="/" method="get" style="display: flex; gap: 8px;">
                <input type="text" name="q" value="{{ current_query }}" placeholder="ì§€ì—­ëª…(ì˜ˆ: ê°•ë‚¨êµ¬, íŒêµë™)ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex-grow: 1; padding: 12px 16px; border-radius: 999px; border: 1px solid #fff; background: rgba(255,255,255,0.2); color: #fff; font-size: 16px;">
                <button type="submit" style="background: #fff; color: #667eea; font-size: 16px;">ê²€ìƒ‰</button>
            </form>
            <div style="display:flex; justify-content:center;">
                <a class="nav-link" href="/regional">ì§€ì—­ë³„ ì‹¤ê±°ë˜ê°€ ë³´ê¸°</a>
            </div>
        </div>
    </header>
    <main>
        <section style="max-width:1200px;margin:-40px auto 24px;padding:0 20px;">
            <div class="complex-card">
                <h2>ëŒ€ì¶œ ê³„ì‚°ê¸° (ì›ë¦¬ê¸ˆê· ë“±ìƒí™˜)</h2>
                <div class="alert-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); align-items: flex-end;">
                    <div>
                        <label for="loanAmount" style="font-size: 13px; color: #6c708c;">ëŒ€ì¶œ ì›ê¸ˆ (ë§Œì›)</label>
                        <input id="loanAmount" type="number" placeholder="ì˜ˆ: 50000">
                    </div>
                    <div>
                        <label for="loanYears" style="font-size: 13px; color: #6c708c;">ëŒ€ì¶œ ê¸°ê°„ (ë…„)</label>
                        <input id="loanYears" type="number" placeholder="ì˜ˆ: 30">
                    </div>
                    <div>
                        <label for="interestRate" style="font-size: 13px; color: #6c708c;">ì—° ì´ììœ¨ (%)</label>
                        <input id="interestRate" type="number" step="0.01" placeholder="ì˜ˆ: 4.5">
                    </div>
                    <div>
                        <label for="repaymentMethod" style="font-size: 13px; color: #6c708c;">ìƒí™˜ ë°©ì‹</label>
                        <select id="repaymentMethod">
                            <option value="amortized">ì›ë¦¬ê¸ˆê· ë“±</option>
                            <option value="equal">ì›ê¸ˆê· ë“±</option>
                            <option value="bullet">ë§Œê¸°ì¼ì‹œ</option>
                        </select>
                    </div>
                    <button onclick="calculateLoan()">ê³„ì‚°í•˜ê¸°</button>
                </div>
                <div id="loanResult" style="margin-top: 20px; background: #f8f9ff; border-radius: 12px; padding: 16px;">
                    <p style="margin: 0; color: #6c708c;">ê³„ì‚°ê¸° ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
                <hr style="border: none; border-top: 1px solid #eef2ff; margin: 20px 0;">
                <div>
                    <label for="neededCashInput" style="font-size: 13px; color: #6c708c; display: block; margin-bottom: 8px;">ë‚´ ë³´ìœ  í˜„ê¸ˆ (ë§Œì›)</label>
                    <input id="neededCashInput" type="number" placeholder="ì˜ˆ: 15000" onkeyup="updateBuyStaySignals()">
                </div>
            </div>
        </section>

        <section class="stats-grid">
            <div class="stat-card">
                <h3>ì „ì²´ ë§¤ë¬¼</h3>
                <div class="value">{{ stats.total_listings }}</div>
            </div>
            <div class="stat-card">
                <h3>ìµœê·¼ 24ì‹œê°„ ì‹ ê·œ/ë³€ë™</h3>
                <div class="value">{{ stats.new_listings }}</div>
            </div>
            <div class="stat-card">
                <h3>í‰ê·  ë§¤ë§¤ ì‹œì„¸</h3>
                <div class="value">{{ stats.avg_price }}</div>
            </div>
            <div class="stat-card">
                <h3>í™œì„± ì•Œë¦¼</h3>
                <div class="value">{{ stats.alert_count }}</div>
            </div>
            <div class="stat-card">
                <h3>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</h3>
                <div class="value" style="font-size:22px;">{{ stats.last_update }}</div>
            </div>
        </section>

        <section class="controls">
            <button onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="crawlNow()">ğŸ•·ï¸ ì§€ê¸ˆ í¬ë¡¤ë§</button>
            <button class="secondary" onclick="toggleAlertForm()">ğŸ”” ì•Œë¦¼ ì„¤ì •</button>
            <button class="secondary" onclick="exportData()">ğŸ“Š ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        </section>

        <section id="alertForm" class="alert-form">
            <h3>ê°€ê²© ì•Œë¦¼ ì„¤ì •</h3>
            <div class="alert-grid">
                <input id="alertComplex" placeholder="ë‹¨ì§€ëª… (ì„ íƒ)">
                <input id="maxPrice" type="number" placeholder="ìµœëŒ€ ê°€ê²© (ë§Œì›)">
                <input id="minArea" type="number" placeholder="ìµœì†Œ ë©´ì  (ã¡)">
                <input id="maxArea" type="number" placeholder="ìµœëŒ€ ë©´ì  (ã¡)">
            </div>
            <button style="margin-top:12px;" onclick="saveAlert()">ì €ì¥</button>
        </section>

        <section class="complex-grid">
            {% for complex in complexes %}
            <article class="complex-card">
                <div class="complex-header">
                    <div>
                        <h2>{{ complex.name }}</h2>
                        <small style="color:#6c708c;">ìµœê·¼ ì§€í‘œê°’</small>
                        <div style="font-size:18px; font-weight:600;">{{ complex.latest_sale }}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <a href="https://fin.land.naver.com/search?q={{ complex.name }}"
                           target="_blank"
                           rel="noreferrer"
                           style="font-size:13px;color:#fff;background:#03C75A;padding:6px 12px;border-radius:999px;text-decoration:none;">
                            ë„¤ì´ë²„ ë¶€ë™ì‚° ê²€ìƒ‰
                        </a>
                        {% if complex.source_url %}
                        <a href="{{ complex.source_url }}"
                           target="_blank"
                           rel="noreferrer"
                           style="font-size:13px;color:#fff;background:#5b67d4;padding:6px 12px;border-radius:999px;text-decoration:none;">
                            ì¶œì²˜
                        </a>
                        {% endif %}
                        <span class="badge {{ complex.change_direction }}">{{ complex.change_text }}</span>
                    </div>
                </div>
                <div class="sparkline">
                    <canvas data-name="{{ complex.name }}"></canvas>
                </div>
                <h3 style="margin:12px 0 6px;">ì£¼ìš” í‰í˜• ì‹œì„¸</h3>
                {% if complex.room_types %}
                <table class="room-types">
                    <thead>
                        <tr>
                            <th>íƒ€ì…</th>
                            <th>ë©´ì </th>
                            <th>ë§¤ë§¤ ì‹œì„¸</th>
                            <th>ì „ì›”ì„¸ ì‹œì„¸</th>
                            <th>ëŒ€ì¶œ ê°€ëŠ¥ì•¡</th>
                            <th>í•„ìš” í˜„ê¸ˆ</th>
                            <th>ì›” ìƒí™˜(ì¶”ì •)</th>
                            <th>ì¶œì²˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rt in complex.room_types %}
                        <tr onclick="updateChart('{{ complex.name }}', '{{ rt.name }}')" style="cursor: pointer;">
                            <td>{{ rt.name }}</td>
                            <td>{{ rt.area }}</td>
                            <td>{{ rt.sales }}</td>
                            <td>{{ rt.rent }}</td>
                            <td>{{ rt.loan_amount }}</td>
                            <td>{{ rt.needed_cash or '-' }}</td>
                            <td>{{ rt.monthly_payment }}</td>
                            <td>
                                {% if rt.source_url %}
                                <a href="{{ rt.source_url }}" target="_blank" rel="noreferrer">ì—´ê¸°</a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty">í‰í˜•ë³„ ì‹œì„¸ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
                {% endif %}

                <h3 style="margin:18px 0 6px;">ì‹¤ì‹œê°„ ë§¤ë¬¼</h3>
                {% if complex.listings %}
                <table class="listing-table">
                    <thead>
                        <tr>
                            <th>ê°€ê²©</th>
                            <th>íƒ€ì…</th>
                            <th>ë©´ì </th>
                            <th>ì¸µ</th>
                            <th>ëŒ€ì¶œ ê°€ëŠ¥ì•¡</th>
                            <th>í•„ìš” í˜„ê¸ˆ</th>
                            <th>ì›” ìƒí™˜(ì¶”ì •)</th>
                            <th>ì¶œì²˜</th>
                            <th>ì¶”ì²œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in complex.listings %}
                        <tr data-needed-cash="{{ item.needed_cash_raw }}">
                            <td>{{ item.price }} {{ item.monthly_rent }}</td>
                            <td>{{ item.price_type }}</td>
                            <td>{{ item.area_type }}</td>
                            <td>{{ item.floor or '-' }}</td>
                            <td>{{ item.loan_amount }}</td>
                            <td>{{ item.needed_cash }}</td>
                            <td>{{ item.monthly_payment }}</td>
                            <td>
                                {% if item.url %}
                                <a href="{{ item.url }}" target="_blank" rel="noreferrer">ëª¨ë°”ì¼</a>
                                {% endif %}
                                {% if item.catalog_url %}
                                {% if item.url %} | {% endif %}
                                <a href="{{ item.catalog_url }}" target="_blank" rel="noreferrer">ì§ë°©ì¡°íšŒ</a>
                                {% elif item.web_url %}
                                {% if item.url %} | {% endif %}
                                <a href="{{ item.web_url }}" target="_blank" rel="noreferrer">ê²€ìƒ‰</a>
                                {% endif %}
                                {% if not item.url and not item.web_url %}
                                -
                                {% endif %}
                            </td>
                            <td class="signal-cell"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty">í˜„ì¬ ê³µê°œëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endif %}
            </article>
            {% endfor %}
        </section>
    </main>


    <script>
        const sparklineData = {{ sparkline_json | safe }};

        function refreshData() {
            window.location.reload();
        }

        function crawlNow() {
            if (confirm("ì•¼íƒ‘ë™ ë§¤ë¬¼/ì‹œì„¸ í¬ë¡¤ë§ì„ ì¦‰ì‹œ ì‹¤í–‰í• ê¹Œìš”?")) {
                fetch("/api/crawl")
                    .then(resp => resp.json())
                    .then(data => {
                        alert(data.message);
                        setTimeout(() => window.location.reload(), 1200);
                    })
                    .catch(err => alert("ìš”ì²­ ì‹¤íŒ¨: " + err));
            }
        }

        function toggleAlertForm() {
            const form = document.getElementById("alertForm");
            form.classList.toggle("active");
        }

        function saveAlert() {
            const payload = {
                complex: document.getElementById("alertComplex").value,
                maxPrice: document.getElementById("maxPrice").value,
                minArea: document.getElementById("minArea").value,
                maxArea: document.getElementById("maxArea").value
            };
            fetch("/api/alert/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
            .then(resp => resp.json())
            .then(data => {
                alert(data.message);
                window.location.reload();
            })
            .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
        }

        function exportData() {
            window.location.href = "/api/export";
        }

        function calculateLoan() {
            const amount = parseFloat(document.getElementById('loanAmount').value) * 10000;
            const years = parseInt(document.getElementById('loanYears').value);
            const rate = parseFloat(document.getElementById('interestRate').value);
            const method = document.getElementById('repaymentMethod').value;
            const resultContainer = document.getElementById('loanResult');

            if (isNaN(amount) || isNaN(years) || isNaN(rate) || amount <= 0 || years <= 0 || rate <= 0) {
                resultContainer.innerHTML = `<p style="margin: 0; color: #a3063f;">ëª¨ë“  í•„ë“œì— ìœ íš¨í•œ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>`;
                return;
            }

            const monthlyRate = rate / 100 / 12;
            const totalMonths = years * 12;
            const formatCurrency = (num) => new Intl.NumberFormat('ko-KR').format(Math.round(num));
            
            let html = '';

            if (method === 'amortized') { // ì›ë¦¬ê¸ˆê· ë“±
                const monthlyPayment = (amount * monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / (Math.pow(1 + monthlyRate, totalMonths) - 1);
                const totalPayment = monthlyPayment * totalMonths;
                const totalInterest = totalPayment - amount;

                html = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px;">
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì›” ìƒí™˜ê¸ˆ (ë§¤ì›” ë™ì¼)</p>
                        <p style="margin: 0; font-size: 16px; font-weight: 600; text-align: right;">ì•½ ${formatCurrency(monthlyPayment)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì´ ëŒ€ì¶œ ì›ê¸ˆ</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">${formatCurrency(amount)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì´ ì´ì</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">${formatCurrency(totalInterest)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì´ ìƒí™˜ê¸ˆì•¡</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">${formatCurrency(totalPayment)} ì›</p>
                    </div>
                `;
            } else if (method === 'equal') { // ì›ê¸ˆê· ë“±
                const monthlyPrincipal = amount / totalMonths;
                let totalInterest = 0;
                let balance = amount;
                for (let i = 0; i < totalMonths; i++) {
                    totalInterest += balance * monthlyRate;
                    balance -= monthlyPrincipal;
                }
                const firstMonthPayment = monthlyPrincipal + (amount * monthlyRate);
                const lastMonthPayment = monthlyPrincipal + (monthlyPrincipal * monthlyRate);
                const totalPayment = amount + totalInterest;

                html = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px;">
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì›” ìƒí™˜ê¸ˆ (ì´ˆê¸°)</p>
                        <p style="margin: 0; font-size: 16px; font-weight: 600; text-align: right;">ì•½ ${formatCurrency(firstMonthPayment)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì›” ìƒí™˜ê¸ˆ (ë§ê¸°)</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">ì•½ ${formatCurrency(lastMonthPayment)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì´ ì´ì</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">${formatCurrency(totalInterest)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì´ ìƒí™˜ê¸ˆì•¡</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">${formatCurrency(totalPayment)} ì›</p>
                    </div>
                `;
            } else if (method === 'bullet') { // ë§Œê¸°ì¼ì‹œ
                const monthlyInterest = amount * monthlyRate;
                const totalInterest = monthlyInterest * totalMonths;
                const totalPayment = amount + totalInterest;

                html = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px;">
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì›” ìƒí™˜ê¸ˆ (ì´ì)</p>
                        <p style="margin: 0; font-size: 16px; font-weight: 600; text-align: right;">ì•½ ${formatCurrency(monthlyInterest)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ë§Œê¸° ìƒí™˜ ì›ê¸ˆ</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">${formatCurrency(amount)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì´ ì´ì</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">${formatCurrency(totalInterest)} ì›</p>
                        <p style="margin: 0; font-size: 14px; color: #6c708c;">ì´ ìƒí™˜ê¸ˆì•¡</p>
                        <p style="margin: 0; font-size: 14px; text-align: right;">${formatCurrency(totalPayment)} ì›</p>
                    </div>
                `;
            }
            resultContainer.innerHTML = html;
        }

        function drawSparkline(canvas, data) {
            if (!data || !data.prices || data.prices.length < 1) {
                canvas.parentElement.innerHTML = "<div class='empty'>ê°€ê²© ì¶”ì„¸ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</div>";
                return;
            }
            const ctx = canvas.getContext("2d");
            
            if (Chart.getChart(canvas)) {
                Chart.getChart(canvas).destroy();
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'ì‹œì„¸ (ë§Œì›)',
                        data: data.prices,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                autoSkip: false, // Disable auto-skipping ticks
                                maxRotation: 45, // Rotate labels for better readability
                                minRotation: 45
                            },
                            min: data.labels[0],
                            max: data.labels[data.labels.length - 1]
                        },
                        y: {
                            ticks: {
                                callback: function(value, index, values) {
                                    return value.toLocaleString('ko-KR') + 'ë§Œ';
                                },
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart(complexName, roomTypeName) {
            const canvas = document.querySelector(`canvas[data-name="${complexName}"]`);
            if (!canvas) return;

            const chartData = sparklineData[complexName] && sparklineData[complexName][roomTypeName];
            if (!chartData) {
                // Data for this room type might not be available, so we do nothing.
                return;
            }

            drawSparkline(canvas, chartData);
        }

        function updateBuyStaySignals() {
            const neededCashInput = document.getElementById('neededCashInput');
            const userCash = parseFloat(neededCashInput.value);

            document.querySelectorAll('.listing-table tbody tr').forEach(row => {
                const neededCashRaw = row.dataset.neededCash;
                const signalCell = row.querySelector('.signal-cell');
                
                if (!signalCell || neededCashRaw === '' || neededCashRaw === undefined) {
                    if(signalCell) signalCell.innerHTML = '';
                    return;
                }

                const listingNeededCash = parseFloat(neededCashRaw);

                if (isNaN(userCash) || userCash <= 0) {
                    signalCell.innerHTML = '';
                    return;
                }

                if (listingNeededCash <= userCash) {
                    signalCell.innerHTML = '<span style="color: #046c4e; font-weight: bold;">BUY</span>';
                } else {
                    signalCell.innerHTML = '<span style="color: #a3063f; font-weight: bold;">STAY</span>';
                }
            });
        }

        document.querySelectorAll("canvas[data-name]").forEach(canvas => {
            const name = canvas.dataset.name;
            // Initially draw the chart for the complex itself
            if (sparklineData[name] && sparklineData[name][name]) {
                drawSparkline(canvas, sparklineData[name][name]);
            }
        });

        // Set initial state for BUY/STAY signals on page load
        updateBuyStaySignals();
    </script>
</body>
</html>
